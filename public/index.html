<!DOCTYPE html>
<html>
	<head>
		<title>Vaccine Availability Alert</title>
		<link rel="stylesheet" type="text/css" href="style.css">

	</head>
	<body>

	<div class="registration-space">

	<div class="registration-form">



	<h2>Get Notified for Vaccine Availability, So Easily !</h2><br>
	<form name="passpin" action="#" method="post">
		<p>PinCode:</p>
		<input type="text" name="pincode" id="pin" placeholder="Pincode">
		<p>Email:</p>
		<input type="email" name="email" id="email" placeholder="Email Id">
		<p>Age_Limit</p>
		<select id="Age_Limit" name="Age_Limit" placeholder="Age-Limit">
		<option value="" selected disabled hidden>Choose Age</option>
		<option value="18">18-45</option>
		<option value="45">45+</option>
		</select><br>

		<p><input type="radio" id="Dose1" name="dose" value="Dose1" onclick="disableCheck()">Dose1</p>
		<p><input type="radio" id="Dose2" name="dose" value="Dose2" onclick="disableCheck()">Dose2</p>
		<select id="Vaccine" name="Vaccine" placeholder="Vaccine" disabled="disabled">
		<option value="" selected disabled hidden>Choose Vaccine For Dose2</option>
		<option value="COVAXIN">Covaxin</option>
		<option value="COVISHIELD">Covishield</option>
		</select><br>

		<p>Mobile No (Optional)<p>
		<div class="alert_msg">(Do not enter any pefix like +91 or 0)</div><br>
		<input type="tel" name="mobile" id="mobile" placeholder="Mobile-No" pattern="[0-9]{10}">
		<br><br>
		<div id="message"></div>
		<button type="button" onclick="getVaccineDetails()" id="subscribe">Subscribe</button>
		<button type="button" onclick="removeVaccineDetails()" id="unsubscribe">Unsubscribe</button>
	</form>
	</div>

	<div class="user_count" id="user_count">

	</div>

	<div class="contact-details">

	<br><br><br>

	<br>
	<br>
	<div class="feedback">
	<a href="mailto:cowislot@gmail.com">Contact us here for any Feedback  </a>
	</div>
	</div>
	<script>

	async function displayCount(){

		const count_url=`count/`;
		const response_count = await fetch(count_url);
		const count_data = await response_count.json();
		console.log(count_data.count);
		var display_msg="Number of Subscriptions : "+"\n"+count_data.count;
		document.getElementById('user_count').innerHTML="<span style='color: white;'>"+display_msg+"</span>";
		document.getElementById('user_count').style.fontSize = "x-large";
		document.getElementById('user_count').style.boxShadow = "10px 20px 30px white";

}

	function disableCheck(){
		var x=document.getElementById("Vaccine");
		if(document.getElementById('Dose1').checked){
			  x.disabled=true;
		}
		else if(document.getElementById('Dose2').checked){
			  x.disabled=false;
		}

					return;
	}


	function validateData(email,mob,dose){
		var valid=1,ind1=1,ind2=1,ind3=1,ind4=1;
		var mailformat = /^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/;
		var mob_format=/^\d{10}$/;
		var vaccine=document.getElementById("Vaccine").value;

		if(!(email.match(mailformat))){
			document.getElementById('message').innerHTML="<span style='color: red;'>Please enter a valid email address</span>";
			ind1=0;
		}

		else if(!(mob.match(mob_format)) && mob.length!=0){
			document.getElementById('message').innerHTML="<span style='color: red;'>Please enter a valid Mobile Number</span>";
			ind2=0;
			}

			else if(dose==undefined){
				document.getElementById('message').innerHTML="<span style='color: red;'>Please select a dose</span>";
				ind3=0;
			}

			else if(dose=="Dose2" && vaccine==""){
				document.getElementById('message').innerHTML="<span style='color: red;'>Please select a vaccine for Dose2</span>";
				ind4=0;
			}

		if(ind1==0 || ind2==0 || ind3==0||ind4==0){
			valid=0;
		}
		return valid;
	}

	function validateDataRemove(email,pin){
		var valid=1,ind1=1,ind2=1,ind3=1;
		var mailformat = /^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/;
		var mob_format=/^\d{10}$/;

		if(!(email.match(mailformat))){
			document.getElementById('message').innerHTML="<span style='color: red;'>Please enter a valid email address</span>";
			ind1=0;
		}

			else if(pin==undefined){
				document.getElementById('message').innerHTML="<span style='color: red;'>Please enter a pin</span>";
				ind3=0;
			}

		if(ind1==0 || ind3==0){
			valid=0;
		}
		return valid;
	}

	async function removeVaccineDetails(){
		const pin=document.getElementById('pin').value;
		//console.log(pin);
		const mob=document.getElementById('mobile').value;
		const email=document.getElementById('email').value;
		const age=document.getElementById('Age_Limit').value;
		var today = new Date();
		var month_today=(today.getMonth()+1);
		console.log(month_today);
		if((month_today.toString().length)<2){
			month_today="0"+month_today.toString();
		}
		console.log(month_today);
		var date_today = today.getDate()+'-'+month_today+'-'+today.getFullYear();
		var dose;
		if(document.getElementById('Dose1').checked){
			dose=document.getElementById('Dose1').value;
		}
		else if(document.getElementById('Dose2').checked){
			dose=document.getElementById('Dose2').value;
		}
		const remove_url=`unsubscribe/${pin},${mob},${email},${age},${dose}`
		console.log(remove_url);

		var valid=validateDataRemove(email,pin);
		console.log('Valid:'+valid);
		if(valid==1){
		if(pin!='' && email!='' && age!=''){
		const response = await fetch(remove_url);
		const data_remove = await response.json();
		console.log(data_remove.message)
		color=data_remove.color;

		if(color=='red'){
		document.getElementById('message').innerHTML="<span style='color: red;'>"+data_remove.message+"</span>";
		}
		else{
		document.getElementById('message').innerHTML="<span style='color: white;'>"+data_remove.message+"</span>";
		document.getElementById('pin').value='';
		document.getElementById('email').value='';
		document.getElementById('Age_Limit').value='';
		document.getElementById('mobile').value='';
		}
		}
		else{
		document.getElementById('message').innerHTML="<span style='color: red;'>**Please fill your Email, Pin & Age</span>";
		}
		}
	}


	async function getVaccineDetails(){
		//console.log('inside function');
		const pin=document.getElementById('pin').value;
		const mob=document.getElementById('mobile').value;
		//const date=document.getElementById('date').value;
		//const date1= date.substring(8,10)+'-'+date.substring(5,7)+'-'+date.substring(0,4);
		const email=document.getElementById('email').value;
		const age=document.getElementById('Age_Limit').value;
		var dose;
		if(document.getElementById('Dose1').checked){
			dose=document.getElementById('Dose1').value;
		}
		else if(document.getElementById('Dose2').checked){
			dose=document.getElementById('Dose2').value;
		}
		console.log(dose);
		const vaccine=document.getElementById("Vaccine").value;
		console.log(vaccine=="");
		var today = new Date();
		var month_today=(today.getMonth()+1);
		//console.log(month_today);
		if((month_today.toString().length)<2){
			month_today="0"+month_today.toString();
		}
		console.log(month_today);
		var date_today = today.getDate()+'-'+month_today+'-'+today.getFullYear();

		var valid=validateData(email,mob,dose);
		//console.log('Valid:'+valid);
		if(valid==1){
		//const api_url='https://cdn-api.co-vin.in/api/v2/appointment/sessions/public/calendarByPin?pincode='+pin+'&date='+date1;
		const api_url=`vaccine/${pin},${mob},${email},${age},${dose},${vaccine}`;
		console.log(document.getElementById('pin').value);
		//console.log(document.getElementById('date').value);
		console.log(date_today);
		console.log(api_url);
		console.log(pin=='');
		console.log(email=='');
		console.log(age=='');
		console.log(date_today=='');

		if(pin!='' && email!='' && age!=''){
		const response = await fetch(api_url);
		const data1 = await response.json();
		console.log(data1.message)
		color=data1.color;

		if(color=='red'){
		document.getElementById('message').innerHTML="<span style='color: red;'>"+data1.message+"</span>";
		document.getElementById('Vaccine').value='';
		}
		else{
		document.getElementById('message').innerHTML="<span style='color: white;'>"+data1.message+"</span>";
		document.getElementById('pin').value='';
		document.getElementById('email').value='';
		document.getElementById('Age_Limit').value='';
		document.getElementById('mobile').value='';
		document.getElementById('Vaccine').value='';
		}
		}
		else{
		document.getElementById('message').innerHTML="<span style='color: red;'>**Please fill in all the details</span>";
		}
		//const data1 = await response.json();
		//console.log(data1);
		}
		}
	</script>
	</body>
</html>
